<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>STEAM Class Chat (Local Login)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    #loginScreen, #chatUI { display:none; }
    #chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
    .message { margin-bottom:8px; padding:4px 6px; border-radius:4px; }
    .own { background:#e6f7ff; }
    .meta { color:gray; font-size:0.85em; margin-left:8px; }
    .smallBtn { padding:4px 6px; font-size:0.85em; margin-left:6px; }
  </style>
</head>
<body>
  <h2>STEAM Chat</h2>

  <!-- ======== Custom Login Screen ======== -->
  <div id="loginScreen">
    <h3>Sign In</h3>
    <p>Enter your full name and class password.</p>
    <input id="username" placeholder="First Last" style="width:60%;padding:8px;"><br><br>
    <input id="password" type="password" placeholder="Class Password" style="width:60%;padding:8px;"><br><br>
    <button id="loginBtn">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- ======== Main Chat UI ======== -->
  <div id="chatUI">
    <p>Signed in as: <strong id="currentUser"></strong>
      <button id="logoutBtn" class="smallBtn">Logout</button></p>
    <div id="rooms">
      <h3>Your Rooms</h3>
      <select id="roomSelect" style="width:60%;"></select>
      <button id="createRoomBtn">Create Private Room</button>
    </div>

    <div id="chatContainer" style="margin-top:20px;">
      <h3 id="roomTitle">Room</h3>
      <div id="chatBox"></div>
      <div style="margin-top:8px;">
        <input id="messageInput" placeholder="Type your message..." style="width:78%;padding:8px;">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ======= Firebase Config =======
    const firebaseConfig = {
      apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
      authDomain: "steam-chat-82c10.firebaseapp.com",
      projectId: "steam-chat-82c10",
      storageBucket: "steam-chat-82c10.firebasestorage.app",
      messagingSenderId: "527558016185",
      appId: "1:527558016185:web:33473cb2098cad5e812f68",
      measurementId: "G-Z6ENYE5ES8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ======= Allowed Users =======
    const students = [
      { name: "Brycen Gallardo" },
      { name: "Liam Pendergast" },
      { name: "Samuel Prather" },
      { name: "Zayden Tenney" },
      { name: "Ammon Rhoten" },
      { name: "Arthur Hagge" },
      { name: "Caleb Clark" },
      { name: "Charlotte Young" },
      { name: "David Graham" },
      { name: "Easton Aker" },
      { name: "Elijah Conti" },
      { name: "Emelia Hulse" },
      { name: "Ethan Hawkins" },
      { name: "Fox Eisinger" },
      { name: "Hans Holland" },
      { name: "Jackson Holcombe" },
      { name: "Joseph Brown" },
      { name: "Kate Russell" },
      { name: "Leah Wilson" },
      { name: "Lincoln LaMarr" },
      { name: "Spencer Nielson" },
      { name: "Torin Castle" },
      { name: "Victor Peters" }
    ];

    // Managers (also students)
    const managers = [
      "Brycen Gallardo", "Liam Pendergast", "Samuel Prather", "Zayden Tenney"
    ];

    const CLASS_PASSWORD = "STEAM2024"; // Shared password (change this!)

    // ======= UI Elements =======
    const loginScreen = document.getElementById("loginScreen");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");
    const chatUI = document.getElementById("chatUI");
    const currentUserEl = document.getElementById("currentUser");
    const logoutBtn = document.getElementById("logoutBtn");
    const roomSelect = document.getElementById("roomSelect");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const chatBox = document.getElementById("chatBox");
    const roomTitle = document.getElementById("roomTitle");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    let currentUser = null;
    let currentRoomId = null;
    let unsubscribeMessages = null;
    let isManager = false;

    // ======= Login Logic =======
    function showLogin() {
      loginScreen.style.display = "block";
      chatUI.style.display = "none";
    }

    function showChat() {
      loginScreen.style.display = "none";
      chatUI.style.display = "block";
    }

    function checkLocalLogin() {
      const saved = localStorage.getItem("steamUser");
      if (saved) {
        currentUser = saved;
        isManager = managers.includes(currentUser);
        currentUserEl.textContent = currentUser + (isManager ? " (Manager)" : "");
        showChat();
        ensurePublicRoom().then(loadRooms);
      } else {
        showLogin();
      }
    }

    loginBtn.onclick = () => {
      const name = usernameInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!name || !pass) return loginError.textContent = "Please enter both fields.";
      const allowed = students.map(s => s.name.toLowerCase());
      if (!allowed.includes(name.toLowerCase())) return loginError.textContent = "Name not recognized.";
      if (pass !== CLASS_PASSWORD) return loginError.textContent = "Incorrect password.";
      localStorage.setItem("steamUser", name);
      currentUser = name;
      isManager = managers.includes(name);
      currentUserEl.textContent = currentUser + (isManager ? " (Manager)" : "");
      usernameInput.value = passwordInput.value = "";
      loginError.textContent = "";
      showChat();
      ensurePublicRoom().then(loadRooms);
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem("steamUser");
      if (unsubscribeMessages) unsubscribeMessages();
      currentUser = null;
      showLogin();
    };

    // ======= Firebase Chat Logic =======
    async function ensurePublicRoom() {
      const q = await db.collection("rooms").where("isPublic", "==", true).limit(1).get();
      if (q.empty) {
        const all = students.map(s => s.name);
        await db.collection("rooms").add({
          name: "Public Room",
          members: all,
          isPublic: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    async function loadRooms() {
      roomSelect.innerHTML = "";
      const snapshot = isManager
        ? await db.collection("rooms").orderBy("createdAt").get()
        : await db.collection("rooms").where("members", "array-contains", currentUser).get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = data.name + (data.isPublic ? " (Public)" : "");
        roomSelect.appendChild(opt);
      });
      if (roomSelect.options.length > 0) {
        currentRoomId = roomSelect.options[0].value;
        const doc = await db.collection("rooms").doc(currentRoomId).get();
        roomTitle.textContent = doc.data().name;
        if (unsubscribeMessages) unsubscribeMessages();
        listenMessages(currentRoomId);
      }
    }

    roomSelect.onchange = async () => {
      currentRoomId = roomSelect.value;
      const doc = await db.collection("rooms").doc(currentRoomId).get();
      roomTitle.textContent = doc.data().name;
      if (unsubscribeMessages) unsubscribeMessages();
      listenMessages(currentRoomId);
    };

    function listenMessages(roomId) {
      unsubscribeMessages = db.collection("messages")
        .where("roomId","==",roomId)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            const m = doc.data();
            const div = document.createElement("div");
            div.className = "message " + (m.sender === currentUser ? "own" : "");
            const time = m.timestamp ? m.timestamp.toDate().toLocaleString() : "";
            div.innerHTML = `<strong>${escapeHtml(m.sender)}</strong>: ${escapeHtml(m.text)} <span class="meta">${time}</span>`;
            if (isManager) {
              const del = document.createElement("button");
              del.textContent = "Delete";
              del.className = "smallBtn";
              del.onclick = () => db.collection("messages").doc(doc.id).delete();
              div.appendChild(del);
            }
            chatBox.appendChild(div);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    sendBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text || !currentRoomId) return;
      await db.collection("messages").add({
        roomId: currentRoomId,
        sender: currentUser,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = "";
    };

    createRoomBtn.onclick = () => {
      const roomName = prompt("Enter private room name:");
      if (!roomName) return;
      const container = document.createElement("div");
      container.id = "createRoomUI";
      container.innerHTML = "<h4>Select students to invite:</h4>";
      const list = document.createElement("div");
      students.forEach(s => {
        const label = document.createElement("label");
        label.style.display = "block";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = s.name;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + s.name));
        list.appendChild(label);
      });
      container.appendChild(list);
      const createBtn = document.createElement("button");
      createBtn.textContent = "Create";
      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "Cancel";
      container.appendChild(createBtn);
      container.appendChild(cancelBtn);
      document.body.appendChild(container);
      cancelBtn.onclick = () => document.body.removeChild(container);
      createBtn.onclick = async () => {
        const selected = Array.from(container.querySelectorAll("input:checked")).map(cb => cb.value);
        if (!selected.includes(currentUser)) selected.push(currentUser);
        if (selected.length === 0) return alert("Select at least one member.");
        await db.collection("rooms").add({
          name: roomName,
          members: selected,
          isPublic: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.body.removeChild(container);
        loadRooms();
      };
    };

    function escapeHtml(t) {
      return t.replace(/[&<"'>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // Run check
    checkLocalLogin();
  </script>
</body>
</html>
