<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>STEAM Class Chat (Secure Login)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
  #loginScreen, #chatUI, #setupPasswordUI, #changePasswordUI, #resetPasswordUI { display:none; }
  #chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
  .message { margin-bottom:8px; padding:4px 6px; border-radius:4px; }
  .own { background:#e6f7ff; }
  .meta { color:gray; font-size:0.85em; margin-left:8px; }
  .smallBtn { padding:4px 6px; font-size:0.85em; margin-left:6px; }
  #modalOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; }
  #modalBox { background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; box-shadow:0 4px 12px rgba(0,0,0,0.2); }

  /* Custom room dropdown */
  .roomDropdown { position: relative; display:inline-block; width:60%; }
  .roomDropdownButton { width:100%; text-align:left; padding:8px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
  .roomMenu { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #ccc; max-height:240px; overflow:auto; z-index:10; display:none; border-radius:4px; margin-top:4px; }
  .roomItem { padding:8px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f0f0f0; }
  .roomItem:last-child{border-bottom:none;}
  .roomName { flex:1; cursor:pointer; }
  .badge { background:#e74c3c; color:white; min-width:22px; padding:2px 6px; border-radius:999px; display:inline-block; text-align:center; font-weight:bold; margin-left:8px; font-size:0.85em; }
  .actions { margin-left:8px; display:flex; gap:6px; }
  .roomHeader { display:flex; align-items:center; gap:8px; }
  #totalUnreadBadge { margin-left:8px; vertical-align:middle; }
</style>
</head>
<body>
<h2>STEAM Chat</h2>

<!-- ======== Login Screen ======== -->
<div id="loginScreen">
  <h3>Sign In</h3>
  <p>Enter your name and password(If you haven't signed in before type anything for your password and then it will ask you to create a password).</p>
  <input id="username" placeholder="First Last" style="width:60%;padding:8px;"><br><br>
  <input id="password" type="password" placeholder="Password" style="width:60%;padding:8px;"><br><br>
  <button id="loginBtn">Login</button>
  <button id="forgotBtn" style="margin-left:10px;">Forgot Password?</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- ======== Create Password Screen ======== -->
<div id="setupPasswordUI">
  <h3>Create a New Password</h3>
  <p>Welcome! Set a password for your account.</p>
  <input id="newPassword" type="password" placeholder="Enter new password" style="width:60%;padding:8px;"><br><br>
  <button id="saveNewPasswordBtn">Save Password</button>
  <p id="setupError" style="color:red;"></p>
</div>

<!-- ======== Change Password ======== -->
<div id="changePasswordUI">
  <h3>Change Your Password</h3>
  <p>Enter your current password and new password.</p>
  <input id="currentPass" type="password" placeholder="Current password" style="width:60%;padding:8px;"><br><br>
  <input id="newPassChange" type="password" placeholder="New password" style="width:60%;padding:8px;"><br><br>
  <button id="changePassBtn">Change Password</button>
  <button id="cancelChangeBtn">Cancel</button>
  <p id="changeError" style="color:red;"></p>
</div>

<!-- ======== Chat UI ======== -->
<div id="chatUI">
  <p>Signed in as: <strong id="currentUser"></strong>
    <button id="logoutBtn" class="smallBtn">Logout</button>
    <button id="changePasswordLink" class="smallBtn">Change Password</button>
  </p>

  <div id="resetPasswordUI">
    <h4>Manager Controls</h4>
    <input id="resetUser" placeholder="User to reset" style="width:50%;padding:6px;">
    <button id="resetPassBtn">Reset User Password</button>
    <p id="resetMsg" style="color:green;"></p>
  </div>

  <div id="rooms">
    <h3 class="roomHeader">
      Your Rooms
      <span id="totalUnreadBadge" class="badge" style="display:none"></span>
    </h3>

    <!-- custom dropdown -->
    <div class="roomDropdown">
      <div id="roomDropdownButton" class="roomDropdownButton">
        <span id="currentRoomLabel">Select a room</span>
        <span style="font-size:0.9em;">â–¾</span>
      </div>
      <div id="roomMenu" class="roomMenu"></div>
    </div>

    <button id="createRoomBtn">Create Private Room</button>
  </div>

  <div id="chatContainer" style="margin-top:20px;">
    <h3 id="roomTitle">Room</h3>
    <div style="margin-bottom:8px;">
      <button id="viewMembersBtn" class="smallBtn">Members</button>
      <button id="deleteRoomBtn" class="smallBtn" style="display:none;background:#f8d7da;border:1px solid #f5c6cb;">Delete Room</button>
    </div>
    <div id="chatBox"></div>
    <div style="margin-top:8px;">
      <input id="messageInput" placeholder="Type your message..." style="width:78%;padding:8px;">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- ======== Private Room Modal ======== -->
<div id="modalOverlay">
  <div id="modalBox">
    <div id="modalContent">
      <!-- content populated dynamically -->
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // ======= Firebase Config (unchanged) =======
  const firebaseConfig = {
    apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
    authDomain: "steam-chat-82c10.firebaseapp.com",
    projectId: "steam-chat-82c10",
    storageBucket: "steam-chat-82c10.firebasestorage.app",
    messagingSenderId: "527558016185",
    appId: "1:527558016185:web:33473cb2098cad5e812f68",
    measurementId: "G-Z6ENYE5ES8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = null;
  let isManager = false;
  let currentRoomId = null;
  let unsubscribeMessages = null;
  const roomSelect = document.getElementById("roomSelect");
  const chatBox = document.getElementById("chatBox");
  const roomTitle = document.getElementById("roomTitle");
  
  // ======= Utility =======
  function escapeHtml(t){return t.replace(/[&<"'>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

  // ======= Mark messages as read =======
  async function markMessagesAsRead(roomId) {
    const snapshot = await db.collection("messages")
      .where("roomId","==",roomId)
      .where("readBy","array-contains",currentUser)
      .get();

    // Update messages that do NOT include currentUser
    const unreadSnapshot = await db.collection("messages")
      .where("roomId","==",roomId)
      .get();
    unreadSnapshot.forEach(async doc => {
      const data = doc.data();
      if(!data.readBy?.includes(currentUser)){
        await db.collection("messages").doc(doc.id)
          .update({ readBy: firebase.firestore.FieldValue.arrayUnion(currentUser) });
      }
    });
  }

  // ======= Listen messages for current room =======
  function listenMessages(roomId){
    unsubscribeMessages = db.collection("messages")
      .where("roomId","==",roomId)
      .orderBy("timestamp")
      .onSnapshot(snapshot=>{
        chatBox.innerHTML="";
        snapshot.forEach(doc=>{
          const m=doc.data();
          const div=document.createElement("div");
          div.className="message "+(m.sender===currentUser?"own":"");
          const time=m.timestamp?m.timestamp.toDate().toLocaleString():"";
          div.innerHTML=`<strong>${escapeHtml(m.sender)}</strong>: ${escapeHtml(m.text)} <span class="meta">${time}</span>`;
          if(isManager){
            const del=document.createElement("button");
            del.textContent="Delete";
            del.className="smallBtn";
            del.onclick=()=>db.collection("messages").doc(doc.id).delete();
            div.appendChild(del);
          }
          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
        // Mark all messages as read when viewing
        markMessagesAsRead(roomId);
        updateUnreadIndicators();
      });
  }

  // ======= Send message =======
  document.getElementById("sendBtn").onclick=async()=>{
    const text=document.getElementById("messageInput").value.trim();
    if(!text||!currentRoomId) return;
    await db.collection("messages").add({
      roomId: currentRoomId,
      sender: currentUser,
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      readBy: [currentUser]
    });
    document.getElementById("messageInput").value="";
  };

  // ======= Load rooms and show unread count =======
  async function loadRooms(){
    roomSelect.innerHTML="";
    const snapshot=isManager?await db.collection("rooms").orderBy("createdAt").get()
      :await db.collection("rooms").where("members","array-contains",currentUser).get();
    const rooms = [];
    snapshot.forEach(doc=>{
      const data=doc.data();
      rooms.push({id: doc.id, name: data.name, isPublic: data.isPublic, members: data.members});
    });

    // For each room, calculate unread count
    for(const room of rooms){
      const unreadSnap = await db.collection("messages")
        .where("roomId","==",room.id)
        .get();
      const unreadCount = unreadSnap.docs.filter(d=>!d.data().readBy?.includes(currentUser)).length;
      const opt=document.createElement("option");
      opt.value=room.id;
      opt.textContent=room.name + (room.isPublic?" (Public)":"") + (unreadCount>0?` (${unreadCount})`:"");
      roomSelect.appendChild(opt);
    }

    if(roomSelect.options.length>0){
      currentRoomId = roomSelect.options[0].value;
      const doc = await db.collection("rooms").doc(currentRoomId).get();
      roomTitle.textContent = doc.data().name;
      if(unsubscribeMessages) unsubscribeMessages();
      listenMessages(currentRoomId);
    }
  }

  roomSelect.onchange = async ()=>{
    currentRoomId = roomSelect.value;
    const doc = await db.collection("rooms").doc(currentRoomId).get();
    roomTitle.textContent = doc.data().name;
    if(unsubscribeMessages) unsubscribeMessages();
    listenMessages(currentRoomId);
  };

  // ======= Show which rooms have unread messages (update in real-time) =======
  async function updateUnreadIndicators(){
    const snapshot = isManager?await db.collection("rooms").orderBy("createdAt").get()
      :await db.collection("rooms").where("members","array-contains",currentUser).get();
    snapshot.forEach(async roomDoc=>{
      const messagesSnap = await db.collection("messages")
        .where("roomId","==",roomDoc.id).get();
      const unread = messagesSnap.docs.filter(d=>!d.data().readBy?.includes(currentUser)).length;
      const option = Array.from(roomSelect.options).find(o=>o.value===roomDoc.id);
      if(option) option.textContent = roomDoc.data().name + (roomDoc.data().isPublic?" (Public)":"") + (unread>0?` (${unread})`:"");
    });
  }

  // ======= Initialize =======
  async function checkLocalLogin(){
    const saved=localStorage.getItem("steamUser");
    if(!saved) return showLogin();
    const snap=await db.collection("userPasswords").doc(saved).get();
    if(!snap.exists){ currentUser=saved; showSetup(); return; }
    currentUser = saved;
    isManager = ["Brycen Gallardo","Liam Pendergast","Samuel Prather","Zayden Tenney"].includes(saved);
    document.getElementById("currentUser").textContent=currentUser + (isManager?" (Manager)":"");
    showChat();
    await ensurePublicRoom();
    loadRooms();
  }

  checkLocalLogin();
</script>
</body>
</html>
