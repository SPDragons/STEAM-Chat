
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>STEAM Class Chat (Secure Login)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    #loginScreen, #chatUI, #setupPasswordUI, #changePasswordUI, #resetPasswordUI { display:none; }
    #chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
    .message { margin-bottom:8px; padding:4px 6px; border-radius:4px; }
    .own { background:#e6f7ff; }
    .meta { color:gray; font-size:0.85em; margin-left:8px; }
    .smallBtn { padding:4px 6px; font-size:0.85em; margin-left:6px; }
    #modalOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    }
    #modalBox {
      background:white; padding:20px; border-radius:8px; width:90%; max-width:500px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .unreadBadge {
      background:red;
      color:white;
      border-radius:50%;
      padding:2px 6px;
      font-size:0.75em;
      margin-left:6px;
    }
  </style>
</head>
<body>
  <h2>STEAM Chat</h2>
  <div id="chatUI">
    <p>Signed in as: <strong id="currentUser"></strong>
      <button id="logoutBtn" class="smallBtn">Logout</button>
      <button id="changePasswordLink" class="smallBtn">Change Password</button>
    </p>
    <div id="rooms">
      <h3>Your Rooms <span id="roomsUnreadBadge" class="unreadBadge" style="display:none;"></span></h3>
      <select id="roomSelect" style="width:60%;"></select>
      <button id="createRoomBtn">Create Private Room</button>
      <button id="deleteRoomBtn" style="display:none;">Delete Room</button>
      <button id="viewMembersBtn">View Members</button>
    </div>
    <div id="chatContainer" style="margin-top:20px;">
      <h3 id="roomTitle">Room</h3>
      <div id="chatBox"></div>
      <div style="margin-top:8px;">
        <input id="messageInput" placeholder="Type your message..." style="width:78%;padding:8px;">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
      authDomain: "steam-chat-82c10.firebaseapp.com",
      projectId: "steam-chat-82c10",
      storageBucket: "steam-chat-82c10.appspot.com",
      messagingSenderId: "527558016185",
      appId: "1:527558016185:web:33473cb2098cad5e812f68",
      measurementId: "G-Z6ENYE5ES8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const currentUserEl = document.getElementById("currentUser");
    const roomSelect = document.getElementById("roomSelect");
    const roomTitle = document.getElementById("roomTitle");
    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const roomsUnreadBadge = document.getElementById("roomsUnreadBadge");
    const deleteRoomBtn = document.getElementById("deleteRoomBtn");
    const viewMembersBtn = document.getElementById("viewMembersBtn");

    let currentUser = "Brycen Gallardo"; // Simulated login
    let currentRoomId = null;
    let isManager = true;
    let unsubscribeMessages = null;

    currentUserEl.textContent = currentUser + (isManager ? " (Manager)" : "");

    async function loadRooms() {
      roomSelect.innerHTML = "";
      let snapshot = await db.collection("rooms").where("members", "array-contains", currentUser).get();
      let totalUnread = 0;
      for (let doc of snapshot.docs) {
        let data = doc.data();
        let roomId = doc.id;
        let unreadSnap = await db.collection("messages")
          .where("roomId", "==", roomId)
          .where("readBy", "not-in", [currentUser])
          .get();
        let unreadCount = unreadSnap.docs.filter(d => !d.data().readBy?.includes(currentUser)).length;
        totalUnread += unreadCount;
        let opt = document.createElement("option");
        opt.value = roomId;
        opt.textContent = data.name + (unreadCount > 0 ? ` (${unreadCount})` : "");
        roomSelect.appendChild(opt);
      }
      roomsUnreadBadge.style.display = totalUnread > 0 ? "inline-block" : "none";
      roomsUnreadBadge.textContent = totalUnread;
      if (roomSelect.options.length > 0) {
        roomSelect.selectedIndex = 0;
        currentRoomId = roomSelect.value;
        loadRoom(currentRoomId);
      }
    }

    async function loadRoom(roomId) {
      let doc = await db.collection("rooms").doc(roomId).get();
      roomTitle.textContent = doc.data().name;
      if (unsubscribeMessages) unsubscribeMessages();
      unsubscribeMessages = db.collection("messages")
        .where("roomId", "==", roomId)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            let m = doc.data();
            let div = document.createElement("div");
            div.className = "message " + (m.sender === currentUser ? "own" : "");
            let time = m.timestamp ? m.timestamp.toDate().toLocaleString() : "";
            div.innerHTML = `<strong>${m.sender}</strong>: ${m.text} <span class="meta">${time}</span>`;
            chatBox.appendChild(div);
            if (!m.readBy?.includes(currentUser)) {
              doc.ref.update({ readBy: firebase.firestore.FieldValue.arrayUnion(currentUser) });
            }
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    roomSelect.onchange = () => {
      currentRoomId = roomSelect.value;
      loadRoom(currentRoomId);
    };

    sendBtn.onclick = async () => {
      let text = messageInput.value.trim();
      if (!text || !currentRoomId) return;
      await db.collection("messages").add({
        roomId: currentRoomId,
        sender: currentUser,
        text,
        readBy: [currentUser],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = "";
    };

    deleteRoomBtn.onclick = async () => {
      if (!currentRoomId || !confirm("Delete this room?")) return;
      await db.collection("rooms").doc(currentRoomId).delete();
      let messages = await db.collection("messages").where("roomId", "==", currentRoomId).get();
      messages.forEach(doc => doc.ref.delete());
      loadRooms();
    };

    viewMembersBtn.onclick = async () => {
      if (!currentRoomId) return;
      let doc = await db.collection("rooms").doc(currentRoomId).get();
      let members = doc.data().members;
      alert("Room Members:\n" + members.join("\n"));
    };

    if (isManager) deleteRoomBtn.style.display = "inline-block";

    loadRooms();
  </script>
</body>
</html>
