<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>STEAM Class Chat (Secure Login)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    #loginScreen, #chatUI { display:none; }
    #chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
    .message { margin-bottom:8px; padding:4px 6px; border-radius:4px; }
    .own { background:#e6f7ff; }
    .meta { color:gray; font-size:0.85em; margin-left:8px; }
    .smallBtn { padding:4px 6px; font-size:0.85em; margin-left:6px; }

    /* Modal for private room creation */
    #modalOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    }
    #modalBox {
      background:white; padding:20px; border-radius:8px; width:90%; max-width:500px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h2>STEAM Chat</h2>

  <!-- ======== Login Screen ======== -->
  <div id="loginScreen">
    <h3>Sign In</h3>
    <p>Enter your full name and class password.</p>
    <input id="username" placeholder="First Last" style="width:60%;padding:8px;"><br><br>
    <input id="password" type="password" placeholder="Class Password" style="width:60%;padding:8px;"><br><br>
    <button id="loginBtn">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- ======== Chat UI ======== -->
  <div id="chatUI">
    <p>Signed in as: <strong id="currentUser"></strong>
      <button id="logoutBtn" class="smallBtn">Logout</button></p>

    <div id="rooms">
      <h3>Your Rooms</h3>
      <select id="roomSelect" style="width:60%;"></select>
      <button id="createRoomBtn">Create Private Room</button>
    </div>

    <div id="chatContainer" style="margin-top:20px;">
      <h3 id="roomTitle">Room</h3>
      <div id="chatBox"></div>
      <div style="margin-top:8px;">
        <input id="messageInput" placeholder="Type your message..." style="width:78%;padding:8px;">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- ======== Private Room Modal ======== -->
  <div id="modalOverlay">
    <div id="modalBox">
      <h3>Create Private Room</h3>
      <label>Room Name:</label>
      <input id="newRoomName" style="width:100%;padding:6px;"><br><br>
      <div id="studentList" style="max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:6px;"></div><br>
      <button id="confirmCreateRoom">Create</button>
      <button id="cancelCreateRoom">Cancel</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ======= Firebase Config =======
    const firebaseConfig = {
      apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
      authDomain: "steam-chat-82c10.firebaseapp.com",
      projectId: "steam-chat-82c10",
      storageBucket: "steam-chat-82c10.firebasestorage.app",
      messagingSenderId: "527558016185",
      appId: "1:527558016185:web:33473cb2098cad5e812f68",
      measurementId: "G-Z6ENYE5ES8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ======= Allowed Users =======
    const students = [
      { name: "Brycen Gallardo" }, { name: "Liam Pendergast" }, { name: "Samuel Prather" },
      { name: "Zayden Tenney" }, { name: "Ammon Rhoten" }, { name: "Arthur Hagge" },
      { name: "Caleb Clark" }, { name: "Charlotte Young" }, { name: "David Graham" },
      { name: "Easton Aker" }, { name: "Elijah Conti" }, { name: "Emelia Hulse" },
      { name: "Ethan Hawkins" }, { name: "Fox Eisinger" }, { name: "Hans Holland" },
      { name: "Jackson Holcombe" }, { name: "Joseph Brown" }, { name: "Kate Russell" },
      { name: "Leah Wilson" }, { name: "Lincoln LaMarr" }, { name: "Spencer Nielson" },
      { name: "Torin Castle" }, { name: "Victor Peters" }
    ];

    const managers = ["Brycen Gallardo", "Liam Pendergast", "Samuel Prather", "Zayden Tenney"];

    // ======= Passwords =======
    const CLASS_PASSWORD = "STEAM2024";      // For students
    const MANAGER_PASSWORD = "STEAM2024";  // For managers

    // ======= UI Elements =======
    const loginScreen = document.getElementById("loginScreen");
    const chatUI = document.getElementById("chatUI");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");
    const currentUserEl = document.getElementById("currentUser");
    const logoutBtn = document.getElementById("logoutBtn");
    const roomSelect = document.getElementById("roomSelect");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const chatBox = document.getElementById("chatBox");
    const roomTitle = document.getElementById("roomTitle");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    // Modal elements
    const modalOverlay = document.getElementById("modalOverlay");
    const newRoomName = document.getElementById("newRoomName");
    const studentList = document.getElementById("studentList");
    const confirmCreateRoom = document.getElementById("confirmCreateRoom");
    const cancelCreateRoom = document.getElementById("cancelCreateRoom");

    let currentUser = null;
    let currentRoomId = null;
    let unsubscribeMessages = null;
    let isManager = false;

    // ======= Login Logic =======
    function showLogin() {
      loginScreen.style.display = "block";
      chatUI.style.display = "none";
    }
    function showChat() {
      loginScreen.style.display = "none";
      chatUI.style.display = "block";
    }

    function checkLocalLogin() {
      const saved = localStorage.getItem("steamUser");
      if (saved) {
        currentUser = saved;
        isManager = managers.includes(currentUser);
        currentUserEl.textContent = currentUser + (isManager ? " (Manager)" : "");
        showChat();
        ensurePublicRoom().then(loadRooms);
      } else showLogin();
    }

    loginBtn.onclick = () => {
      const name = usernameInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!name || !pass) return loginError.textContent = "Please enter both fields.";

      const allowedNames = students.map(s => s.name.toLowerCase());
      if (!allowedNames.includes(name.toLowerCase()))
        return loginError.textContent = "Name not recognized.";

      const isInManagers = managers.includes(name);

      if (isInManagers && pass !== MANAGER_PASSWORD)
        return loginError.textContent = "Manager password required.";
      if (!isInManagers && pass !== CLASS_PASSWORD)
        return loginError.textContent = "Incorrect class password.";

      // Save login
      localStorage.setItem("steamUser", name);
      currentUser = name;
      isManager = isInManagers;
      currentUserEl.textContent = currentUser + (isManager ? " (Manager)" : "");
      usernameInput.value = passwordInput.value = "";
      loginError.textContent = "";
      showChat();
      ensurePublicRoom().then(loadRooms);
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem("steamUser");
      if (unsubscribeMessages) unsubscribeMessages();
      currentUser = null;
      showLogin();
    };

    // ======= Firebase Logic =======
    async function ensurePublicRoom() {
      const q = await db.collection("rooms").where("isPublic", "==", true).limit(1).get();
      if (q.empty) {
        const all = students.map(s => s.name);
        await db.collection("rooms").add({
          name: "Public Room",
          members: all,
          isPublic: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    async function loadRooms() {
      roomSelect.innerHTML = "";
      const snapshot = isManager
        ? await db.collection("rooms").orderBy("createdAt").get()
        : await db.collection("rooms").where("members", "array-contains", currentUser).get();

      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = data.name + (data.isPublic ? " (Public)" : "");
        roomSelect.appendChild(opt);
      });

      if (roomSelect.options.length > 0) {
        currentRoomId = roomSelect.options[0].value;
        const doc = await db.collection("rooms").doc(currentRoomId).get();
        roomTitle.textContent = doc.data().name;
        if (unsubscribeMessages) unsubscribeMessages();
        listenMessages(currentRoomId);
      }
    }

    roomSelect.onchange = async () => {
      currentRoomId = roomSelect.value;
      const doc = await db.collection("rooms").doc(currentRoomId).get();
      roomTitle.textContent = doc.data().name;
      if (unsubscribeMessages) unsubscribeMessages();
      listenMessages(currentRoomId);
    };

    function listenMessages(roomId) {
      unsubscribeMessages = db.collection("messages")
        .where("roomId","==",roomId)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            const m = doc.data();
            const div = document.createElement("div");
            div.className = "message " + (m.sender === currentUser ? "own" : "");
            const time = m.timestamp ? m.timestamp.toDate().toLocaleString() : "";
            div.innerHTML = `<strong>${escapeHtml(m.sender)}</strong>: ${escapeHtml(m.text)} <span class="meta">${time}</span>`;
            if (isManager) {
              const del = document.createElement("button");
              del.textContent = "Delete";
              del.className = "smallBtn";
              del.onclick = () => db.collection("messages").doc(doc.id).delete();
              div.appendChild(del);
            }
            chatBox.appendChild(div);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    sendBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text || !currentRoomId) return;
      await db.collection("messages").add({
        roomId: currentRoomId,
        sender: currentUser,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = "";
    };

    // ======= Private Room Creation (Embed Safe) =======
    createRoomBtn.onclick = () => {
      modalOverlay.style.display = "flex";
      newRoomName.value = "";
      studentList.innerHTML = "";
      students.forEach(s => {
        const label = document.createElement("label");
        label.style.display = "block";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = s.name;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + s.name));
        studentList.appendChild(label);
      });
    };

    cancelCreateRoom.onclick = () => { modalOverlay.style.display = "none"; };

    confirmCreateRoom.onclick = async () => {
      const roomName = newRoomName.value.trim();
      if (!roomName) return alert("Please enter a room name.");
      const selected = Array.from(studentList.querySelectorAll("input:checked")).map(cb => cb.value);
      if (!selected.includes(currentUser)) selected.push(currentUser);
      if (selected.length === 0) return alert("Select at least one member.");
      await db.collection("rooms").add({
        name: roomName,
        members: selected,
        isPublic: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      modalOverlay.style.display = "none";
      loadRooms();
    };

    // ======= Helpers =======
    function escapeHtml(t) {
      return t.replace(/[&<"'>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    checkLocalLogin();
  </script>
</body>
</html>
