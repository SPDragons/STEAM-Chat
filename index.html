<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>STEAM Class Chat (Secure Login)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
#loginScreen, #chatUI, #setupPasswordUI, #changePasswordUI, #resetPasswordUI { display:none; }
#chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
.message { margin-bottom:8px; padding:4px 6px; border-radius:4px; }
.own { background:#e6f7ff; }
.meta { color:gray; font-size:0.85em; margin-left:8px; }
.smallBtn { padding:4px 6px; font-size:0.85em; margin-left:6px; }
#modalOverlay, #membersModal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; justify-content:center; align-items:center; background: rgba(0,0,0,0.5); }
#modalBox, #membersModal div { background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
.redDot { background:red; color:white; border-radius:50%; padding:2px 6px; font-size:0.75em; margin-left:4px; }
#membersList { max-height:300px; overflow-y:auto; list-style:none; padding-left:0; }
</style>
</head>
<body>
<h2>STEAM Chat</h2>

<!-- Login, setup, change password sections remain unchanged -->
<div id="loginScreen">
<h3>Sign In</h3>
<p>Enter your name and password(If you haven't signed in before type anything for your password and then it will ask you to create a password).</p>
<input id="username" placeholder="First Last" style="width:60%;padding:8px;"><br><br>
<input id="password" type="password" placeholder="Password" style="width:60%;padding:8px;"><br><br>
<button id="loginBtn">Login</button>
<button id="forgotBtn" style="margin-left:10px;">Forgot Password?</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="setupPasswordUI">
<h3>Create a New Password</h3>
<p>Welcome! Set a password for your account.</p>
<input id="newPassword" type="password" placeholder="Enter new password" style="width:60%;padding:8px;"><br><br>
<button id="saveNewPasswordBtn">Save Password</button>
<p id="setupError" style="color:red;"></p>
</div>

<div id="changePasswordUI">
<h3>Change Your Password</h3>
<p>Enter your current password and new password.</p>
<input id="currentPass" type="password" placeholder="Current password" style="width:60%;padding:8px;"><br><br>
<input id="newPassChange" type="password" placeholder="New password" style="width:60%;padding:8px;"><br><br>
<button id="changePassBtn">Change Password</button>
<button id="cancelChangeBtn">Cancel</button>
<p id="changeError" style="color:red;"></p>
</div>

<!-- Chat UI -->
<div id="chatUI">
<p>Signed in as: <strong id="currentUser"></strong> 
<button id="logoutBtn" class="smallBtn">Logout</button> 
<button id="changePasswordLink" class="smallBtn">Change Password</button>
</p>

<div id="resetPasswordUI">
<h4>Manager Controls</h4>
<input id="resetUser" placeholder="User to reset" style="width:50%;padding:6px;">
<button id="resetPassBtn">Reset User Password</button>
<p id="resetMsg" style="color:green;"></p>
</div>

<div id="rooms">
<h3>Your Rooms</h3>
<select id="roomSelect" style="width:60%;"></select>
<button id="createRoomBtn">Create Private Room</button>
<button id="viewMembersBtn" class="smallBtn">View Members</button>
<button id="deleteRoomBtn" class="smallBtn" style="background:red;color:white;">Delete Current Room</button>
</div>

<div id="chatContainer" style="margin-top:20px;">
<h3 id="roomTitle">Room</h3>
<div id="chatBox"></div>
<div style="margin-top:8px;">
<input id="messageInput" placeholder="Type your message..." style="width:78%;padding:8px;">
<button id="sendBtn">Send</button>
</div>
</div>
</div>

<!-- Private Room Modal -->
<div id="modalOverlay">
<div id="modalBox">
<h3>Create Private Room</h3>
<label>Room Name:</label>
<input id="newRoomName" style="width:100%;padding:6px;"><br><br>
<div id="studentList" style="max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:6px;"></div><br>
<button id="confirmCreateRoom">Create</button>
<button id="cancelCreateRoom">Cancel</button>
</div>
</div>

<!-- Members Modal -->
<div id="membersModal">
<div>
<h3>Room Members</h3>
<ul id="membersList"></ul>
<button id="closeMembersModal">Close</button>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
authDomain: "steam-chat-82c10.firebaseapp.com",
projectId: "steam-chat-82c10",
storageBucket: "steam-chat-82c10.firebasestorage.app",
messagingSenderId: "527558016185",
appId: "1:527558016185:web:33473cb2098cad5e812f68",
measurementId: "G-Z6ENYE5ES8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Users & Managers
const students = [
{ name: "Brycen Gallardo" }, { name: "Liam Pendergast" }, { name: "Samuel Prather" }, { name: "Zayden Tenney" }, { name: "Ammon Rhoten" }, { name: "Arthur Hagge" }, { name: "Caleb Clark" }, { name: "Charlotte Young" }, { name: "David Graham" }, { name: "Easton Aker" }, { name: "Elijah Conti" }, { name: "Emelia Hulse" }, { name: "Ethan Hawkins" }, { name: "Fox Eisinger" }, { name: "Hans Holland" }, { name: "Jackson Holcombe" }, { name: "Joseph Brown" }, { name: "Kate Russell" }, { name: "Leah Wilson" }, { name: "Lincoln LaMarr" }, { name: "Spencer Nielson" }, { name: "Torin Castle" }, { name: "Victor Peters" }
];
const managers = ["Brycen Gallardo", "Liam Pendergast", "Samuel Prather", "Zayden Tenney"];

// Elements
const loginScreen = document.getElementById("loginScreen");
const setupPasswordUI = document.getElementById("setupPasswordUI");
const changePasswordUI = document.getElementById("changePasswordUI");
const resetPasswordUI = document.getElementById("resetPasswordUI");
const chatUI = document.getElementById("chatUI");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const forgotBtn = document.getElementById("forgotBtn");
const loginError = document.getElementById("loginError");
const newPasswordInput = document.getElementById("newPassword");
const saveNewPasswordBtn = document.getElementById("saveNewPasswordBtn");
const setupError = document.getElementById("setupError");
const currentUserEl = document.getElementById("currentUser");
const logoutBtn = document.getElementById("logoutBtn");
const changePasswordLink = document.getElementById("changePasswordLink");
const currentPass = document.getElementById("currentPass");
const newPassChange = document.getElementById("newPassChange");
const changePassBtn = document.getElementById("changePassBtn");
const cancelChangeBtn = document.getElementById("cancelChangeBtn");
const changeError = document.getElementById("changeError");
const resetUserInput = document.getElementById("resetUser");
const resetPassBtn = document.getElementById("resetPassBtn");
const resetMsg = document.getElementById("resetMsg");
const roomSelect = document.getElementById("roomSelect");
const createRoomBtn = document.getElementById("createRoomBtn");
const chatBox = document.getElementById("chatBox");
const roomTitle = document.getElementById("roomTitle");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const modalOverlay = document.getElementById("modalOverlay");
const newRoomName = document.getElementById("newRoomName");
const studentList = document.getElementById("studentList");
const confirmCreateRoom = document.getElementById("confirmCreateRoom");
const cancelCreateRoom = document.getElementById("cancelCreateRoom");
const viewMembersBtn = document.getElementById("viewMembersBtn");
const deleteRoomBtn = document.getElementById("deleteRoomBtn");
const membersModal = document.getElementById("membersModal");
const membersList = document.getElementById("membersList");
const closeMembersModal = document.getElementById("closeMembersModal");

let currentUser = null;
let isManager = false;
let currentRoomId = null;
let unsubscribeMessages = null;

// ======= Show/Hide Functions =======
function showLogin(){ loginScreen.style.display="block"; setupPasswordUI.style.display=chatUI.style.display=changePasswordUI.style.display="none"; }
function showChat(){ loginScreen.style.display=setupPasswordUI.style.display=changePasswordUI.style.display="none"; chatUI.style.display="block"; resetPasswordUI.style.display=isManager?"block":"none"; }
function showSetup(){ loginScreen.style.display=chatUI.style.display=changePasswordUI.style.display="none"; setupPasswordUI.style.display="block"; }
function showChange(){ chatUI.style.display="none"; changePasswordUI.style.display="block"; }

// ======= Forgot Password =======
forgotBtn.onclick = ()=>window.open("https://forms.gle/Lreooph31a8UDzoMA","_blank");

// ======= Login & Password Handling =======
// ... existing login/setup/change password code (unchanged) ...

// ======= Logout =======
logoutBtn.onclick = ()=>{
    localStorage.removeItem("steamUser");
    if(unsubscribeMessages) unsubscribeMessages();
    currentUser=null;
    showLogin();
};

// ======= Load Rooms & Messages =======
// ... existing room loading and listenMessages code (unchanged) ...

// ======= Send Message =======
sendBtn.onclick=async()=>{
    const text=messageInput.value.trim(); if(!text||!currentRoomId)return;
    await db.collection("messages").add({ roomId:currentRoomId, sender:currentUser, text, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
    messageInput.value="";
};

// ======= Private Room Creation =======
createRoomBtn.onclick=()=>{
    modalOverlay.style.display="flex"; newRoomName.value=""; studentList.innerHTML="";
    students.forEach(s=>{
        const label=document.createElement("label");
        label.style.display="block";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.value=s.name;
        label.appendChild(cb); label.appendChild(document.createTextNode(" "+s.name));
        studentList.appendChild(label);
    });
};
cancelCreateRoom.onclick=()=>{modalOverlay.style.display="none";};
confirmCreateRoom.onclick=async()=>{
    const name=newRoomName.value.trim(); if(!name)return alert("Enter room name.");
    const selected=Array.from(studentList.querySelectorAll("input:checked")).map(cb=>cb.value);
    if(!selected.includes(currentUser)) selected.push(currentUser);
    await db.collection("rooms").add({name, members:selected, isPublic:false, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    modalOverlay.style.display="none"; loadRooms();
};

// ======= View Members Modal =======
viewMembersBtn.onclick=async()=>{
    if(!currentRoomId) return;
    const doc=await db.collection("rooms").doc(currentRoomId).get();
    const members=doc.data().members||[];
    membersList.innerHTML="";
    members.forEach(m=>{
        const li=document.createElement("li");
        li.textContent=m; li.style.padding="4px 0";
        membersList.appendChild(li);
    });
    membersModal.style.display="flex";
};
closeMembersModal.onclick=()=>{membersModal.style.display="none";};

// ======= Delete Current Room (Manager Only) =======
deleteRoomBtn.onclick=async()=>{
    if(!currentRoomId) return;
    if(!isManager) return alert("Only managers can delete rooms.");
    const doc=await db.collection("rooms").doc(currentRoomId).get();
    if(!doc.exists) return;
    const roomName=doc.data().name;
    if(confirm(`Delete room "${roomName}"? This deletes all messages.`)){
        await db.collection("rooms").doc(currentRoomId).delete();
        const msgs=await db.collection("messages").where("roomId","==",currentRoomId).get();
        msgs.forEach(m=>db.collection("messages").doc(m.id).delete());
        currentRoomId=null;
        chatBox.innerHTML="";
        roomTitle.textContent="Room deleted";
        loadRooms();
    }
};

// ======= Helper =======
function escapeHtml(t){return t.replace(/[&<"'>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

// Check local login
checkLocalLogin();
</script>
</body>
</html>
