<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>STEAM Class Chat</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    #loginBtn, #logoutBtn { margin: 5px; }
    #rooms, #chatContainer, #createRoomUI { margin-top: 20px; }
    #chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
    #messageInput { width: 78%; padding: 8px; }
    #sendBtn { padding: 8px 12px; }
    .message { margin-bottom: 8px; padding:4px 6px; border-radius:4px; }
    .own { background:#e6f7ff; }
    .meta { color: gray; font-size:0.85em; margin-left:8px; }
    .smallBtn { padding:4px 6px; margin-left:6px; font-size:0.85em; }
  </style>
</head>
<body>
  <h2>STEAM Chat Room</h2>
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" style="display:none;">Sign out</button>
  <span id="signedInUser" style="margin-left:12px;"></span>
  <p id="accessDenied" style="color:red; display:none;">Access Denied: You are not authorized to use this chat.</p>

  <div id="rooms" style="display:none;">
    <h3>Your Rooms</h3>
    <select id="roomSelect" style="width:60%;"></select>
    <button id="createRoomBtn">Create Private Room</button>
  </div>

  <div id="chatContainer" style="display:none;">
    <h3 id="roomTitle">Room</h3>
    <div id="chatBox"></div>
    <div style="margin-top:8px;">
      <input id="messageInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // ================= Firebase Config =================
    const firebaseConfig = {
      apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
      authDomain: "steam-chat-82c10.firebaseapp.com",
      projectId: "steam-chat-82c10",
      storageBucket: "steam-chat-82c10.appspot.com", // ✅ fixed
      messagingSenderId: "527558016185",
      appId: "1:527558016185:web:33473cb2098cad5e812f68",
      measurementId: "G-Z6ENYE5ES8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ================= Student and Manager Lists =================
    const students = [
      { name: "Brycen Gallardo", email: "brycen.gallardo@students.rsd.edu" },
      { name: "Liam Pendergast", email: "liam.pendergast@students.rsd.edu" },
      { name: "Samuel Prather", email: "samuel.prather@students.rsd.edu" },
      { name: "Zayden Tenney", email: "zayden.tenney@students.rsd.edu" },
      { name: "Ammon Rhoten", email: "ammon.rhoten@students.rsd.edu" },
      { name: "Arthur Hagge", email: "arthur.hagge@students.rsd.edu" },
      { name: "Caleb Clark", email: "caleb.clark@students.rsd.edu" },
      { name: "Charlotte Young", email: "charlotte.young2@students.rsd.edu" },
      { name: "David Graham", email: "david.graham01@students.rsd.edu" },
      { name: "Easton Aker", email: "easton.aker@students.rsd.edu" },
      { name: "Elijah Conti", email: "elijah.conti@students.rsd.edu" },
      { name: "Emelia Hulse", email: "emelia.hulse@students.rsd.edu" },
      { name: "Ethan Hawkins RSD", email: "ethan.hawkins@students.rsd.edu" },
      { name: "Ethan Hawkins LC", email: "ethan.hawkins@libertychristian.net" },
      { name: "Fox Eisinger", email: "fox.eisinger@students.rsd.edu" },
      { name: "Hans Holland", email: "hans.holland@students.rsd.edu" },
      { name: "Jackson Holcombe", email: "jackson.holcombe@students.rsd.edu" },
      { name: "Joseph Brown", email: "joseph.brown@students.rsd.edu" },
      { name: "Kate Russell", email: "kate.russell@students.rsd.edu" },
      { name: "Leah Wilson", email: "leah.wilson@students.rsd.edu" },
      { name: "Lincoln LaMarr", email: "lincoln.lamarr@students.rsd.edu" },
      { name: "Spencer Nielson", email: "spencer.nielson@students.rsd.edu" },
      { name: "Torin Castle", email: "torin.castle@students.rsd.edu" },
      { name: "Victor Peters", email: "victor.peters@students.rsd.edu" }
    ];

    const managers = [
      "brycen.gallardo@students.rsd.edu",
      "liam.pendergast@students.rsd.edu",
      "samuel.prather@students.rsd.edu",
      "zayden.tenney@students.rsd.edu"
    ];

    // ================= UI Elements =================
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const signedInUser = document.getElementById("signedInUser");
    const accessDenied = document.getElementById("accessDenied");
    const roomsDiv = document.getElementById("rooms");
    const roomSelect = document.getElementById("roomSelect");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const chatContainer = document.getElementById("chatContainer");
    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const roomTitle = document.getElementById("roomTitle");

    let currentUser = null;
    let currentRoomId = null;
    let unsubscribeMessages = null;
    let isManager = false;

    // ================= Auth =================
    loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    logoutBtn.onclick = () => auth.signOut();

    async function ensurePublicRoom() {
      const q = await db.collection("rooms").where("isPublic", "==", true).limit(1).get();
      if (q.empty) {
        const allEmails = students.map(s => s.email);
        await db.collection("rooms").add({
          name: "Public Room",
          members: allEmails,
          isPublic: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    auth.onAuthStateChanged(async user => {
      if (unsubscribeMessages) { // ✅ cleanup listener on logout
        unsubscribeMessages();
        unsubscribeMessages = null;
      }

      if (user) {
        currentUser = user;
        signedInUser.textContent = "Signed in as: " + user.email;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";

        const allowedEmails = students.map(s => s.email);
        isManager = managers.includes(user.email);

        if (!allowedEmails.includes(user.email) && !isManager) {
          accessDenied.style.display = "block";
          roomsDiv.style.display = "none";
          chatContainer.style.display = "none";
          return;
        }

        accessDenied.style.display = "none";
        await ensurePublicRoom(); // ✅ moved here
        roomsDiv.style.display = "block";
        chatContainer.style.display = "block";
        await loadRooms();
      } else {
        currentUser = null;
        signedInUser.textContent = "";
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        roomsDiv.style.display = "none";
        chatContainer.style.display = "none";
      }
    });

    // ================= Load Rooms =================
    async function loadRooms() {
      roomSelect.innerHTML = "";
      const snapshot = isManager
        ? await db.collection("rooms").orderBy("createdAt").get()
        : await db.collection("rooms").where("members", "array-contains", currentUser.email).get();

      if (snapshot.empty) {
        const opt = document.createElement("option");
        opt.textContent = "No rooms available";
        roomSelect.appendChild(opt);
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = data.name + (data.isPublic ? " (Public)" : "");
        roomSelect.appendChild(opt);
      });

      currentRoomId = roomSelect.options[0].value;
      const doc = await db.collection("rooms").doc(currentRoomId).get();
      roomTitle.textContent = doc.data().name;
      if (unsubscribeMessages) unsubscribeMessages();
      listenMessages(currentRoomId);
    }

    roomSelect.addEventListener("change", async e => {
      currentRoomId = e.target.value;
      const doc = await db.collection("rooms").doc(currentRoomId).get();
      roomTitle.textContent = doc.data().name;
      if (unsubscribeMessages) unsubscribeMessages();
      listenMessages(currentRoomId);
    });

    function listenMessages(roomId) {
      chatBox.innerHTML = "";
      unsubscribeMessages = db.collection("messages")
        .where("roomId", "==", roomId)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") appendMessage(change.doc);
            else if (change.type === "removed") {
              const msgDiv = document.getElementById(change.doc.id);
              if (msgDiv) msgDiv.remove();
            }
          });
        });
    }

    function appendMessage(doc) {
      const m = doc.data();
      const div = document.createElement("div");
      div.id = doc.id;
      div.className = "message " + (m.senderEmail === currentUser.email ? "own" : "");
      const time = m.timestamp ? m.timestamp.toDate().toLocaleString() : "";
      div.innerHTML = `<strong>${escapeHtml(m.senderName)}</strong>: ${escapeHtml(m.text)} <span class="meta">${escapeHtml(time)}</span>`;
      if (isManager) {
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "smallBtn";
        del.onclick = async () => {
          if (confirm("Delete this message?")) await db.collection("messages").doc(doc.id).delete();
        };
        div.appendChild(del);
      }
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.onclick = async () => sendMessage();

    messageInput.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !currentRoomId) return;
      await db.collection("messages").add({
        text,
        roomId: currentRoomId,
        senderName: currentUser.displayName || "Anonymous",
        senderEmail: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      messageInput.value = "";
      messageInput.focus();
    }

    createRoomBtn.onclick = () => {
      const roomName = prompt("Enter private room name:");
      if (!roomName) return;
      const container = document.createElement("div");
      container.id = "createRoomUI";
      container.innerHTML = "<h4>Select students to invite:</h4>";
      const list = document.createElement("div");
      students.forEach(s => {
        const label = document.createElement("label");
        label.style.display = "block";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = s.email;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + s.name));
        list.appendChild(label);
      });
      container.appendChild(list);
      const createBtn = document.createElement("button");
      createBtn.textContent = "Create";
      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "Cancel";
      container.appendChild(createBtn);
      container.appendChild(cancelBtn);
      document.body.appendChild(container);
      cancelBtn.onclick = () => document.body.removeChild(container);
      createBtn.onclick = async () => {
        const selected = Array.from(container.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
        if (!selected.includes(currentUser.email)) selected.push(currentUser.email);
        if (selected.length === 0) { alert("Select at least one member"); return; }
        await db.collection("rooms").add({
          name: roomName,
          members: selected,
          isPublic: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.body.removeChild(container);
        await loadRooms();
      };
    };

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<"'>]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c]));
    }
  </script>
</body>
</html>
