<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>STEAM Class Chat (Secure Login)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    #loginScreen, #chatUI, #setupPasswordUI, #changePasswordUI, #resetPasswordUI { display:none; }
    #chatBox { height: 420px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background:#fafafa; }
    .message { margin-bottom:8px; padding:4px 6px; border-radius:4px; }
    .own { background:#e6f7ff; }
    .meta { color:gray; font-size:0.85em; margin-left:8px; }
    .smallBtn { padding:4px 6px; font-size:0.85em; margin-left:6px; }

    /* === Red dot unread badge === */
    .badge {
      background: red; color: white;
      border-radius: 50%; padding: 2px 6px;
      font-size: 0.75em; margin-left: 6px;
    }
    .room-badge {
      background: red; color: white;
      border-radius: 50%; padding: 1px 4px;
      font-size: 0.7em; margin-left: 4px;
    }

    #modalOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    }
    #modalBox {
      background:white; padding:20px; border-radius:8px; width:90%; max-width:500px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h2>STEAM Chat</h2>

  <!-- ======== Login Screen ======== -->
  <div id="loginScreen">
    <h3>Sign In</h3>
    <p>Enter your name and password.</p>
    <input id="username" placeholder="First Last" style="width:60%;padding:8px;"><br><br>
    <input id="password" type="password" placeholder="Password" style="width:60%;padding:8px;"><br><br>
    <button id="loginBtn">Login</button>
    <button id="forgotBtn" style="margin-left:10px;">Forgot Password?</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- ======== Create Password Screen ======== -->
  <div id="setupPasswordUI">
    <h3>Create a New Password</h3>
    <p>Welcome! Set a password for your account.</p>
    <input id="newPassword" type="password" placeholder="Enter new password" style="width:60%;padding:8px;"><br><br>
    <button id="saveNewPasswordBtn">Save Password</button>
    <p id="setupError" style="color:red;"></p>
  </div>

  <!-- ======== Change Password ======== -->
  <div id="changePasswordUI">
    <h3>Change Your Password</h3>
    <p>Enter your current password and new password.</p>
    <input id="currentPass" type="password" placeholder="Current password" style="width:60%;padding:8px;"><br><br>
    <input id="newPassChange" type="password" placeholder="New password" style="width:60%;padding:8px;"><br><br>
    <button id="changePassBtn">Change Password</button>
    <button id="cancelChangeBtn">Cancel</button>
    <p id="changeError" style="color:red;"></p>
  </div>

  <!-- ======== Chat UI ======== -->
  <div id="chatUI">
    <p>Signed in as: <strong id="currentUser"></strong>
      <button id="logoutBtn" class="smallBtn">Logout</button>
      <button id="changePasswordLink" class="smallBtn">Change Password</button>
    </p>

    <div id="resetPasswordUI">
      <h4>Manager Controls</h4>
      <input id="resetUser" placeholder="User to reset" style="width:50%;padding:6px;">
      <button id="resetPassBtn">Reset User Password</button>
      <p id="resetMsg" style="color:green;"></p>
    </div>

    <div id="rooms">
      <h3>Your Rooms <span id="unreadBadge" class="badge" style="display:none;">0</span></h3>
      <select id="roomSelect" style="width:60%;"></select>
      <button id="createRoomBtn">Create Private Room</button>
      <button id="viewMembersBtn">View Members</button>
      <button id="deleteRoomBtn" style="display:none;">Delete Room</button>
    </div>

    <div id="chatContainer" style="margin-top:20px;">
      <h3 id="roomTitle">Room</h3>
      <div id="chatBox"></div>
      <div style="margin-top:8px;">
        <input id="messageInput" placeholder="Type your message..." style="width:78%;padding:8px;">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- ======== Private Room Modal ======== -->
  <div id="modalOverlay">
    <div id="modalBox">
      <h3>Create Private Room</h3>
      <label>Room Name:</label>
      <input id="newRoomName" style="width:100%;padding:6px;"><br><br>
      <div id="studentList" style="max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:6px;"></div><br>
      <button id="confirmCreateRoom">Create</button>
      <button id="cancelCreateRoom">Cancel</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ======= Firebase Config =======
  const firebaseConfig = {
    apiKey: "AIzaSyC3q0jqh2zfzKXwHyA6wjPe_dL5t5CGds0",
    authDomain: "steam-chat-82c10.firebaseapp.com",
    projectId: "steam-chat-82c10",
    storageBucket: "steam-chat-82c10.firebasestorage.app",
    messagingSenderId: "527558016185",
    appId: "1:527558016185:web:33473cb2098cad5e812f68",
    measurementId: "G-Z6ENYE5ES8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ======= User Lists =======
  const students = [
    { name: "Brycen Gallardo" }, { name: "Liam Pendergast" }, { name: "Samuel Prather" },
    { name: "Zayden Tenney" }, { name: "Ammon Rhoten" }, { name: "Arthur Hagge" },
    { name: "Caleb Clark" }, { name: "Charlotte Young" }, { name: "David Graham" },
    { name: "Easton Aker" }, { name: "Elijah Conti" }, { name: "Emelia Hulse" },
    { name: "Ethan Hawkins" }, { name: "Fox Eisinger" }, { name: "Hans Holland" },
    { name: "Jackson Holcombe" }, { name: "Joseph Brown" }, { name: "Kate Russell" },
    { name: "Leah Wilson" }, { name: "Lincoln LaMarr" }, { name: "Spencer Nielson" },
    { name: "Torin Castle" }, { name: "Victor Peters" }
  ];
  const managers = ["Brycen Gallardo", "Liam Pendergast", "Samuel Prather", "Zayden Tenney"];

  // ======= UI Elements =======
  const roomSelect=document.getElementById("roomSelect");
  const unreadBadge=document.getElementById("unreadBadge");
  const deleteRoomBtn=document.getElementById("deleteRoomBtn");
  const viewMembersBtn=document.getElementById("viewMembersBtn");
  const chatBox=document.getElementById("chatBox");
  const roomTitle=document.getElementById("roomTitle");
  const messageInput=document.getElementById("messageInput");
  const sendBtn=document.getElementById("sendBtn");

  let currentUser=null,isManager=false,currentRoomId=null,unsubscribeMessages=null;
  let roomUnreadCounts={};

  // ======= Unread Tracking =======
  async function updateUnreadCounts(){
    const user=currentUser;
    const snapshot=await db.collection("rooms").where("members","array-contains",user).get();
    let totalUnread=0;
    roomUnreadCounts={};

    const lastReadsRef=db.collection("userLastReads").doc(user);
    const lastReadsSnap=await lastReadsRef.get();
    const lastReads=lastReadsSnap.exists?lastReadsSnap.data():{};

    for(const doc of snapshot.docs){
      const roomId=doc.id;
      const lastRead=lastReads[roomId]?lastReads[roomId].toDate():new Date(0);
      const unreadSnap=await db.collection("messages")
        .where("roomId","==",roomId)
        .where("timestamp",">",firebase.firestore.Timestamp.fromDate(lastRead))
        .get();
      const count=unreadSnap.size;
      roomUnreadCounts[roomId]=count;
      if(count>0) totalUnread+=count;
    }
    unreadBadge.textContent=totalUnread;
    unreadBadge.style.display=totalUnread>0?"inline-block":"none";

    // refresh room dropdown with badge text
    for(let i=0;i<roomSelect.options.length;i++){
      const opt=roomSelect.options[i];
      const c=roomUnreadCounts[opt.value]||0;
      opt.textContent=opt.textContent.replace(/\s*\(\d+\)$/, ""); // clean
      if(c>0) opt.textContent+=" ("+c+")";
    }
  }

  async function markRoomRead(roomId){
    const user=currentUser;
    await db.collection("userLastReads").doc(user).set({
      [roomId]:firebase.firestore.Timestamp.now()
    },{merge:true});
    updateUnreadCounts();
  }

  // ======= Room Functions =======
  async function loadRooms(){
    roomSelect.innerHTML="";
    const snapshot=isManager
      ?await db.collection("rooms").orderBy("createdAt").get()
      :await db.collection("rooms").where("members","array-contains",currentUser).get();
    snapshot.forEach(doc=>{
      const data=doc.data();
      const opt=document.createElement("option");
      opt.value=doc.id; opt.textContent=data.name+(data.isPublic?" (Public)":"");
      roomSelect.appendChild(opt);
    });
    updateUnreadCounts();
    if(roomSelect.options.length>0){
      currentRoomId=roomSelect.options[0].value;
      openRoom(currentRoomId);
    }
  }

  async function openRoom(id){
    currentRoomId=id;
    const doc=await db.collection("rooms").doc(id).get();
    const data=doc.data();
    roomTitle.textContent=data.name;
    deleteRoomBtn.style.display=isManager?"inline-block":"none";
    if(unsubscribeMessages) unsubscribeMessages();
    listenMessages(id);
    markRoomRead(id);
  }

  roomSelect.onchange=()=>openRoom(roomSelect.value);

  function listenMessages(roomId){
    unsubscribeMessages=db.collection("messages").where("roomId","==",roomId).orderBy("timestamp")
    .onSnapshot(snapshot=>{
      chatBox.innerHTML="";
      snapshot.forEach(doc=>{
        const m=doc.data();
        const div=document.createElement("div");
        div.className="message "+(m.sender===currentUser?"own":"");
        const time=m.timestamp?m.timestamp.toDate().toLocaleString():"";
        div.innerHTML=`<strong>${escapeHtml(m.sender)}</strong>: ${escapeHtml(m.text)} <span class="meta">${time}</span>`;
        if(isManager){
          const del=document.createElement("button");
          del.textContent="Delete"; del.className="smallBtn";
          del.onclick=()=>db.collection("messages").doc(doc.id).delete();
          div.appendChild(del);
        }
        chatBox.appendChild(div);
      });
      chatBox.scrollTop=chatBox.scrollHeight;
      updateUnreadCounts();
    });
  }

  sendBtn.onclick=async()=>{
    const text=messageInput.value.trim();
    if(!text||!currentRoomId)return;
    await db.collection("messages").add({
      roomId:currentRoomId,sender:currentUser,text,
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    messageInput.value="";
  };

  // ===== Manager delete room =====
  deleteRoomBtn.onclick=async()=>{
    if(!confirm("Delete this room and all messages?"))return;
    const roomId=currentRoomId;
    const msgs=await db.collection("messages").where("roomId","==",roomId).get();
    const batch=db.batch();
    msgs.forEach(d=>batch.delete(d.ref));
    batch.delete(db.collection("rooms").doc(roomId));
    await batch.commit();
    alert("Room deleted.");
    loadRooms();
  };

  // ===== View Members =====
  viewMembersBtn.onclick=async()=>{
    if(!currentRoomId)return;
    const doc=await db.collection("rooms").doc(currentRoomId).get();
    const members=doc.data().members;
    alert("Members:\n"+members.join("\n"));
  };

  // ===== Escape Helper =====
  function escapeHtml(t){return t.replace(/[&<"'>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

  // ===== Initialize Login etc (shortened for space) =====
  // ... (Keep all your existing login, password, and setup functions exactly as before)
  // Just insert updateUnreadCounts() after loadRooms() wherever it's called.

  </script>
</body>
</html>
